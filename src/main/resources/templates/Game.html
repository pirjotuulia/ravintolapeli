<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Food Critic</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" rel="stylesheet"/>
    <style>
        .field {
            width: 350px;
            height: 40em;
            padding: 10px;
            border: 1px solid #aaaaaa;
        }

        .card {
            width: 18em;
            height: 26em;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            background-color: black;
            margin: auto;
            position: absolute;
            cursor: move;
            -webkit-box-shadow: 5px 5px 9px 0px rgba(0, 0, 0, 0.75);
            -moz-box-shadow: 5px 5px 9px 0px rgba(0, 0, 0, 0.75);
            box-shadow: 5px 5px 9px 0px rgba(0, 0, 0, 0.75);
        }

        .inner {
            background-color: cornflowerblue;
            margin: 0.5em;
            padding: 0.3em;
            height: 25em;
            background: rgb(30, 87, 153); /* Old browsers */
            background: -moz-linear-gradient(top, rgba(30, 87, 153, 1) 0%, rgba(41, 137, 216, 1) 50%, rgba(32, 124, 202, 1) 51%, rgba(125, 185, 232, 1) 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, rgba(30, 87, 153, 1) 0%, rgba(41, 137, 216, 1) 50%, rgba(32, 124, 202, 1) 51%, rgba(125, 185, 232, 1) 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, rgba(30, 87, 153, 1) 0%, rgba(41, 137, 216, 1) 50%, rgba(32, 124, 202, 1) 51%, rgba(125, 185, 232, 1) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#1e5799', endColorstr='#7db9e8', GradientType=0); /* IE6-9 */
        }

        .title {
            font-weight: bold;
            -webkit-border-top-left-radius: 5px;
            -webkit-border-top-right-radius: 5px;
            -moz-border-radius-topleft: 5px;
            -moz-border-radius-topright: 5px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .title, .illo, .story {
            background-color: skyblue;
            margin: 0.3em;
            padding: 0.2em 0.5em;
        }

        .illo {
            min-height: 9em;
            text-align: center;
            max-height: 9em;
        }

        .pic {
            min-height: 8em;
            text-align: center;
            max-height: 8em;
            max-width: 100%;
        }

        .story {
            min-height: 11em;
            max-height: 11em;
            -webkit-border-bottom-right-radius: 5px;
            -webkit-border-bottom-left-radius: 5px;
            -moz-border-radius-bottomright: 5px;
            -moz-border-radius-bottomleft: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .card:nth-of-type(1) {
            top: 4.0em;
            left: 5em;
        }

        .card:nth-of-type(2) {
            top: 6.5em;
            left: 4em;
        }

        .card:nth-of-type(3) {
            top: 9.0em;
            left: 3em;
        }

        .card:nth-of-type(4) {
            top: 11.5em;
            left: 2em;
        }

        .card:nth-of-type(5) {
            top: 14.0em;
            left: 1em;
        }

        .noselect {
            cursor: pointer;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none;
            /* Non-prefixed version, currently
                                             supported by Chrome and Opera */
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<script th:inline="javascript">
    function mappi(long, lat) {
        $("#osm-map").remove();
        $("#mapHere").append("<div id='osm-map' style='height:300px'></div>");

        var element = document.getElementById('osm-map');

        var x = "" + long;
        var y = "" + lat;

        var cx = [[${gamestats.getLatitude()}]];
        var cy = [[${gamestats.getLongitude()}]];
        var currentLoc = cx + cy;

        var restaurants = [
            ["Restaurant", x, y],
            ["Current location", cx, cy]

        ];

        var map = L.map(element).setView([cx, cy], 10);
        mapLink =
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; ' + mapLink + ' Contributors',
            }).addTo(map);

        for (var i = 0; i < restaurants.length; i++) {
            marker = new L.marker([restaurants[i][1], restaurants[i][2]])
                .bindPopup(restaurants[i][0])
                .addTo(map);
        }
    }
</script>
<script>
    function moveCard(index) {
        // Tämä pyyntö ensin käynnistää metodin, joka siirtää kortin pelattujen listalle
        $.ajax("http://localhost:8080/card/" + index, {type: 'GET'});
        document.location.reload(true);
    }
</script>
<script>
    function cycleDeck(index) {
        $.ajax("http://localhost:8080/top/" + index, {type: 'GET'});
        document.location.reload(true);
    }
</script>
<script>
    function resetGame() {
        $.ajax("http://localhost:8080/reset", {type: 'GET'});
        document.location.reload(true);
    }
</script>
<script th:inline="javascript">
    function selectRestaurant(fLong, fLat, tLong, tLat, index) {
        // Kutsuu funktiota, joka katsoo tie-datasta nykyisen ja valitun ravintolan etäisyyden
        var distance = getDistance(fLat, fLong, tLat, tLong);
        // Tekee pyynnön play-osoitteeseen, joka pelaa kierroksen loppuun
        $.ajax("http://localhost:8080/play/" + index + "/" + distance, {type: 'GET'});
        document.location.reload(false);
    }
</script>
<body>
<div class="page-header text-center">
    <h1>Food Critic</h1>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <h3>Player Stats</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-4">
            <p th:inline="text"><span style="color:red" class="glyphicon glyphicon-heart">   </span>
                [[${gamestats.getHealth()}
                + '/100']]</p>
        </div>
        <div class="col-sm-4">
            <p th:inline="text"><span style="color:green" class="glyphicon glyphicon-usd">   </span>
                [[${#numbers.formatDecimal(gamestats.getMoney(),
                1, 2)} + '/200.00']]</p>
        </div>
        <div th:if="${gamestats.isLastMove()}" class="hide col-sm-4">
            <p th:inline="text" th:onclick="|mappi('${gamestats.getLatitude()}','${gamestats.getLongitude()}')|"><span
                    style="color:blue" class="glyphicon glyphicon-map-marker">   </span> Current location </p>
        </div>
        <div th:unless="${gamestats.isLastMove()}" class="hide col-sm-4">
            <p th:inline="text" th:onclick="|mappi('${gamestats.getLatitude()}','${gamestats.getLongitude()}')|"><span
                    style="color:blue" class="glyphicon glyphicon-map-marker">   </span> Times Square </p>
        </div>
        <div class="col-sm-4">
            <button class="btn-primary" onclick="resetGame()">Start New Game</button>
        </div>
    </div>
    <div class="row">
        <div th:if="${gamestats.isLastMove()}" class="alert alert-success fade in col-sm-12">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Your Action: </strong>You traveled <span
                th:text="${#numbers.formatDecimal(gamestats.getLastMove().getDistanceInMiles(),1,1)}"></span> miles in
            Uber, which cost you $<span
                th:text="${#numbers.formatDecimal(gamestats.getLastMove().getUsedMoney(),1,2)}"></span>. You dined at to
            <strong th:text="${gamestats.getLastMove().getRestaurantName()}"></strong>, which cost you <span
                th:text="${gamestats.getLastMove().getUsedHealth()}"></span> points of health.
        </div>
        <div th:unless="${gamestats.isLastMove()}" class="alert alert-info fade in col-sm-12">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Your Goal: </strong>You work as a food critic in New York: you eat for free, but you have a travel
            budget. Being a busy person, you use Uber to travel from one restaurant to another. Eating a lot every day
            is unhealthy, particularly if you eat in a place that hasn't performed well in health inspections, so watch
            out also for your health! You have five randomized missions, which you can complete in any order, but since
            transportation is costly, plan wisely.
        </div>
    </div>
    <div class="row" th:if="${gamestats.isGameOver()}">
        <div th:if="${gamestats.isLastMove()}" class="alert alert-danger fade in col-sm-12">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Game Over: </strong>You have run out of money and can't pay for the trip! The Uber driver calls the
            police, who takes you away!
        </div>
        <div th:if="${gamestats.isLastMove()}" class="alert alert-danger fade in col-sm-12">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Game Over: </strong>You keel over, feeling sick in the stomach! You have run out of health points!
        </div>
        <div th:if="${gamestats.isLastMove()}" class="alert alert-info fade in col-sm-12">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>You Win: </strong>Congratulations! You have successfully completed all your missions!
        </div>
    </div>
    <div id="main" class="row">
        <div class="col-sm-6">
            <h3>In Hand</h3>
            <div id="hand" class="field" style="background-color: #DDD">
                <div class="card slidable" th:each="card,iter: ${gamestats.hand}" th:id="${card._id}">
                    <div class='inner'>
                        <div class="title" th:text="${card.title}" th:onclick="|cycleDeck('${iter.index}')|"></div>
                        <div class="illo"><img class='pic center' th:src="${card.imageurl}"
                                               th:onclick="|moveCard('${iter.index}','${card.borough}','${card.cuisine}','${card.name}')|">
                        </div>
                        <div class="story" th:text="${card.story}"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <h3>In Play</h3>
            <div id="play" class="field" style="background-color: #DDD">
                <div class="card slidable" th:each="card,iter: ${gamestats.playedMissions}" th:id="${card._id}">
                    <div class='inner'>
                        <div class="title" th:text="${card.title}"></div>
                        <div class="illo"><img class='pic center' th:src="${card.imageurl}"></div>
                        <div class="story" th:text="${card.story}"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <h3>Restaurants</h3>
            <table id="table" class="table">
                <thead>
                <th>Restaurant</th>
                <th>Address</th>
                </thead>
                <tbody>
                <tr class="slidable noselect" th:if="${gamestats.isMissionMode()}==true"
                    th:each="restaurant, iter: ${gamestats.getRestaurantList()}"
                    th:onclick="|mappi('${restaurant.getLatitude()}','${restaurant.getLongitude()}')|">
                    <td th:text="${restaurant.name}"></td>
                    <td th:text="${restaurant.address.street}"></td>
                    <td>
                        <button class="btn-primary"
                                th:onclick="|selectRestaurant('${gamestats.getLongitude()}','${gamestats.getLatitude()}','${restaurant.getLongitude()}','${restaurant.getLatitude()}','${iter.index}')|">
                            Go!
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="mapHere" class="col-sm-6">
            <h3>Map View</h3>
        </div>
    </div>
</div>
<footer style="padding:3em">Copyright 2018 Mikko, Elmo ja Pirjo</footer>

<script th:inline="javascript">
    var lat = [[${gamestats.getLatitude()}]];
    var long = [[${gamestats.getLongitude()}]];
    window.onload = mappi(lat, long), reset;

    function reset() {
        window.scrollTo(0, 0);
    }
</script>
<script type="text/javascript" th:src="@{/js/distance.js}"></script>
</body>
</html>